(this.webpackJsonpui=this.webpackJsonpui||[]).push([[0],{16:function(e,t,a){e.exports=a(34)},34:function(e,t,a){"use strict";a.r(t);var r=a(0),n=a.n(r),o=a(13),s=a.n(o),c=(a(8),a(1));function l(e){let{totalSpots:t,freeSpots:a}=e;return n.a.createElement("header",{className:"flex items-center justify-between p-4 bg-white shadow"},n.a.createElement("h1",{className:"text-2xl font-bold text-gray-900"},"Smart Parking (",a,"/",t," free)"))}function i(e){let{notes:t,onFilter:a,muted:o,toggleMute:s}=e;const[c,l]=Object(r.useState)(!1);return n.a.createElement("div",{className:"fixed top-4 right-4 w-64 z-50"},n.a.createElement("div",{className:"flex items-center justify-between mb-2"},n.a.createElement("h2",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100"},"Alerts"),n.a.createElement("button",{onClick:()=>l(e=>!e),className:"text-sm text-blue-600 dark:text-blue-400"},c?"Expand":"Collapse")),!c&&n.a.createElement("ul",{className:"bg-white dark:bg-gray-800 shadow rounded overflow-auto max-h-60"},t.map((e,t)=>n.a.createElement("li",{key:t,onClick:()=>a(e.spot_id),className:"p-2 border-b last:border-b-0 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer"},n.a.createElement("div",{className:"font-medium text-gray-900 dark:text-gray-100"},"Spot ",e.spot_id," freed"),n.a.createElement("div",{className:"text-sm text-gray-500 dark:text-gray-400"},new Date(e.timestamp).toLocaleTimeString())))),n.a.createElement("div",{className:"mt-2 text-right"},n.a.createElement("button",{onClick:s,className:"text-sm text-red-500 dark:text-red-300"},o?"Unmute":"Mute")))}function d(e){let{id:t,isFree:a,freeSince:o,highlight:s}=e;const[c,l]=Object(r.useState)(0);return Object(r.useEffect)(()=>{if(!a)return void l(0);const e=new Date(o).getTime();if(isNaN(e))return console.warn("SpotTile ".concat(t,": Invalid freeSince timestamp received: ").concat(o)),void l(0);const r=setInterval(()=>{const t=Math.max(0,Math.floor((Date.now()-e)/1e3));l(t)},1e3);return()=>{clearInterval(r),console.log("SpotTile ".concat(t,": Counter interval cleared."))}},[a,o,t]),n.a.createElement("div",{className:"\n        p-4 flex flex-col items-center justify-center\n        rounded-lg shadow cursor-pointer\n        ".concat(a?"bg-green-200 text-green-800":"bg-red-200 text-red-800","\n        ").concat(s?"ring-4 ring-blue-500":"","\n      "),onClick:()=>{}},n.a.createElement("div",{className:"font-semibold mb-2"},"Spot ",t),a?n.a.createElement("div",{className:"text-sm"},isNaN(c)?"Status unknown":"Free for ".concat(c,"s")):n.a.createElement("div",{className:"text-sm"},"Occupied"))}var u=a(15);function m(e){let{initialSpots:t,videoSize:a,onSave:o,setSpots:s,apiBaseUrl:l}=e;const[i,d]=Object(r.useState)([]),[m,g]=Object(r.useState)([]),[b,p]=Object(r.useState)(null),h=Object(r.useMemo)(()=>l?"".concat(l,"/webcam_feed"):"",[l]);Object(r.useEffect)(()=>{console.log("[SpotsEditor] Initializing with initialSpots:",t);const e=t.map(e=>Object(c.a)(Object(c.a)({},e),{},{id:String(e.id),x:Math.round(e.x||0),y:Math.round(e.y||0),w:Math.round(e.w||50),h:Math.round(e.h||50)}));d(e),g([e]),p(null)},[t]);const f=e=>{d(e),g(t=>[...t.slice(-19),e])},S=(e,t,a,r,n)=>{const o=i.map(o=>String(o.id)===String(e)?Object(c.a)(Object(c.a)({},o),{},{x:Math.round(t),y:Math.round(a),w:Math.round(r),h:Math.round(n)}):o);f(o)};return n.a.createElement("div",{className:"p-4 bg-gray-50 dark:bg-gray-800 rounded-lg shadow-inner"},n.a.createElement("div",{className:"flex flex-wrap gap-3 mb-4"},n.a.createElement("button",{onClick:()=>{const e=i.length>0?Math.max(0,...i.map(e=>parseInt(e.id,10)))+1:1,t={id:String(e),x:20,y:20,w:100,h:80,is_available:!0};console.log("[SpotsEditor] Adding new box:",t);const a=[...i,t];f(a)},className:"px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-150 ease-in-out"},"Add Spot"),n.a.createElement("button",{onClick:()=>{if(null==b)return;const e=i.filter(e=>String(e.id)!==String(b));console.log("[SpotsEditor] Removing box, new list:",e),f(e),p(null)},disabled:null==b,className:"px-4 py-2 bg-red-600 text-white rounded-lg shadow hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition duration-150 ease-in-out"},"Remove Selected"),n.a.createElement("button",{onClick:()=>{if(m.length<2)return;const e=m.slice(0,-1),t=e[e.length-1];g(e),d(t),s&&s(t),p(null)},disabled:m.length<2,className:"px-4 py-2 bg-yellow-500 text-white rounded-lg shadow hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-opacity-50 transition duration-150 ease-in-out"},"Undo"),n.a.createElement("button",{onClick:()=>{console.log("[SpotsEditor] handleSave called. currentSpots:",JSON.parse(JSON.stringify(i)));const e=i.map(e=>({id:String(e.id),x:Math.round(e.x),y:Math.round(e.y),w:Math.round(e.w),h:Math.round(e.h)}));console.log("[SpotsEditor] spotsToSave (passed to App.js onSave):",e),o(e)},className:"px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out"},"Save Configuration")),n.a.createElement("div",{className:"relative border-2 border-gray-400 dark:border-gray-600 rounded-lg overflow-hidden bg-black",style:{width:a.width,height:a.height},onClick:e=>{e.target===e.currentTarget&&p(null)}},h?n.a.createElement("img",{src:h,alt:"Live feed for spot configuration",className:"absolute inset-0 w-full h-full object-contain",onError:e=>{e.target.alt="Video feed unavailable. Check backend.",e.target.style.display="none"}}):n.a.createElement("div",{className:"absolute inset-0 w-full h-full flex items-center justify-center text-white bg-gray-700"},"Video feed URL not configured."),i.map(e=>n.a.createElement(u.a,{key:e.id,bounds:"parent",size:{width:e.w,height:e.h},position:{x:e.x,y:e.y},onDragStop:(t,a)=>S(e.id,a.x,a.y,e.w,e.h),onResizeStop:(t,a,r,n,o)=>S(e.id,o.x,o.y,r.offsetWidth,r.offsetHeight),onClick:t=>{t.stopPropagation(),p(e.id)},style:{border:"2px dashed ".concat(String(b)===String(e.id)?"blue":"rgba(255,255,255,0.7)"),backgroundColor:String(b)===String(e.id)?"rgba(0,0,255,0.2)":"rgba(255,255,255,0.1)",boxSizing:"border-box",cursor:"move"},className:"transition-all duration-100 ease-in-out"},n.a.createElement("div",{className:"flex items-center justify-center w-full h-full text-white text-sm font-bold pointer-events-none select-none"},e.id)))))}const g={video:{width:640,height:480}};var b=e=>{let{apiBaseUrl:t,onStreamingActive:a}=e;const[o,s]=Object(r.useState)(!1),[c,l]=Object(r.useState)(!1),[i,d]=Object(r.useState)(null),[u,m]=Object(r.useState)("Idle"),b=Object(r.useRef)(null),p=Object(r.useRef)(null),h=Object(r.useRef)(null),f=Object(r.useRef)(null),S=Object(r.useMemo)(()=>t?"".concat(t,"/api/upload_frame"):(console.warn("[WebcamStreamer] apiBaseUrl is null/undefined, uploadFrameEndpoint will be null."),null),[t]);Object(r.useEffect)(()=>()=>{f.current&&clearInterval(f.current)},[S]);const w=Object(r.useCallback)(async()=>{d(null),m("Starting camera...");try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("getUserMedia not supported.");{const e=await navigator.mediaDevices.getUserMedia(g);h.current=e,b.current&&(b.current.srcObject=e,await b.current.play()),s(!0),m("Camera active."),console.log("[WebcamStreamer] Camera started successfully.")}}catch(e){console.error("[WebcamStreamer] Error starting camera:",e.name,e.message),d("Cam Error: ".concat(e.name," - ").concat(e.message,".")),m("Camera error."),s(!1),a&&a(!1)}},[a]),v=Object(r.useCallback)(()=>{f.current&&(clearInterval(f.current),f.current=null),h.current&&(h.current.getTracks().forEach(e=>e.stop()),h.current=null),b.current&&(b.current.srcObject=null),l(!1),s(!1),a&&a(!1),m("Camera stopped.")},[a]),x=Object(r.useCallback)(async()=>{if(!b.current||!p.current||!o||!S)return;const e=b.current,t=p.current;if(0===e.videoWidth||0===e.videoHeight||e.paused||e.ended)return;t.width=e.videoWidth,t.height=e.videoHeight;t.getContext("2d").drawImage(e,0,0,t.width,t.height);const a=t.toDataURL("image/jpeg",.7);try{const e=await fetch(S,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({frame:a})});if(!e.ok){const t=await e.text();console.error("[WebcamStreamer] HTTP error sending frame: ".concat(e.status," ").concat(e.statusText),t),d("HTTP error: ".concat(e.status,". Check console."))}}catch(r){console.error("[WebcamStreamer] Network error sending frame via HTTP POST:",r),d("Network error sending frame. Check console.")}},[o,S]);Object(r.useEffect)(()=>(c&&o?(f.current&&clearInterval(f.current),f.current=setInterval(x,200),m("Streaming ".concat(5," FPS via HTTP")),console.log("[WebcamStreamer] Started HTTP frame sending at ".concat(5," FPS")),a&&a(!0)):(f.current&&(clearInterval(f.current),f.current=null,m(o?"Camera active, not streaming.":"Streaming stopped.")),a&&!1===c&&a(!1)),()=>{f.current&&clearInterval(f.current)}),[c,o,x,a]),Object(r.useEffect)(()=>()=>{v()},[v]);return n.a.createElement("div",{className:"p-4 bg-gray-800 text-white rounded-lg shadow-xl w-full max-w-2xl mx-auto my-8 font-sans"},n.a.createElement("h3",{className:"text-xl font-semibold mb-4 text-center text-teal-400"},"Webcam (HTTP Upload Mode)"),n.a.createElement("div",{className:"mb-4 bg-black rounded-md overflow-hidden shadow-inner"},n.a.createElement("video",{ref:b,muted:!0,autoPlay:!0,playsInline:!0,className:"w-full h-auto aspect-video"})),n.a.createElement("canvas",{ref:p,style:{display:"none"}}),n.a.createElement("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4"},o?n.a.createElement("button",{onClick:v,className:"w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg shadow"},"Stop Camera"):n.a.createElement("button",{onClick:w,className:"w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-lg shadow"},"Start Camera"),o&&!c?n.a.createElement("button",{onClick:async()=>{if(d(null),!o){if(await w(),!h.current)return;await new Promise(e=>setTimeout(e,50))}if(o||h.current)console.log("[WebcamStreamer] Camera is active, setting isStreaming to true for HTTP."),l(!0);else{const e="Camera could not be activated. Cannot start streaming.";console.error("[WebcamStreamer]",e),i||d(e),m("Camera not ready.")}},disabled:!o,className:"w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg shadow disabled:opacity-50"},"Start HTTP Streaming"):o&&c?n.a.createElement("button",{onClick:()=>{l(!1)},className:"w-full bg-yellow-500 hover:bg-yellow-600 text-black font-semibold py-2 px-3 rounded-lg shadow"},"Stop HTTP Streaming"):n.a.createElement("div",{className:"w-full bg-gray-700 text-gray-400 font-semibold py-2 px-3 rounded-lg shadow text-center text-sm"},"Start camera to enable streaming")),n.a.createElement("div",{className:"space-y-2 text-xs sm:text-sm"},i&&n.a.createElement("div",{className:"bg-red-700 border border-red-900 text-white px-3 py-2 rounded-lg",role:"alert"},n.a.createElement("strong",null,"Error: "),n.a.createElement("span",{className:"block sm:inline"},i)),n.a.createElement("div",{className:"p-2 rounded-lg shadow ".concat(o?"bg-green-700":"bg-gray-700")},n.a.createElement("span",{className:"font-semibold"},"Camera:")," ",o?"Active":"Inactive"),n.a.createElement("div",{className:"p-2 rounded-lg shadow ".concat(c?"bg-green-700":"bg-gray-700")},n.a.createElement("span",{className:"font-semibold"},"HTTP Streaming:")," ",c?"Active (".concat(5," FPS)"):"Inactive"," (",u,")")))};const p=Object({NODE_ENV:"production",PUBLIC_URL:"",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0}).REACT_APP_API_BASE_URL||"http://localhost:8000",h="".concat(p,"/webcam_feed"),f="".concat(p,"/api/nuke_test_save"),S="".concat(p,"/api/spots_v10_get");function w(){const[e,t]=Object(r.useState)(!1),[a,o]=Object(r.useState)([]),[s,u]=Object(r.useState)({}),[g,w]=Object(r.useState)({}),[v,x]=Object(r.useState)([]),[y,E]=Object(r.useState)(!1),[N,O]=Object(r.useState)(null),[j,k]=Object(r.useState)("webcam"),[C,T]=Object(r.useState)(Date.now()),P=Object(r.useRef)({}),_=(Object(r.useCallback)(()=>p?p.startsWith("https://")?"wss://".concat(p.substring(8),"/ws/video_stream_upload"):p.startsWith("http://")?"ws://".concat(p.substring(7),"/ws/video_stream_upload"):(console.error("[App.js] Cannot determine WebSocket protocol from API_BASE_URL:",p),null):(console.error("[App.js] API_BASE_URL is not set."),null),[])(),Object(r.useCallback)(()=>{fetch(S).then(e=>{if(!e.ok){const t="HTTP error ".concat(e.status," (").concat(e.statusText,") while fetching spots from ").concat(S);throw console.error(t,e),new Error(t)}return e.json()}).then(e=>{if(e&&e.spots){const t=e.spots,a=[],r={};t.forEach(e=>{const t=String(e.id);a.push({id:t,x:e.x,y:e.y,w:e.w,h:e.h}),r[t]=!e.is_available});const n=[];w(e=>{const t=Object(c.a)({},e);return a.forEach(e=>{const a=e.id,o=r[a];if(!0===P.current[a]&&!1===o){const e=(new Date).toISOString();if(t[a]=e,!y){const t="".concat(a,"-").concat(e,"-").concat(Math.random());n.push({id:t,spot_id:a,timestamp:e})}}else!0===o?delete t[a]:!1===o&&void 0===t[a]&&(t[a]=(new Date).toISOString())}),t}),o(a),u(r),n.length>0&&x(e=>[...n,...e].slice(0,5)),P.current=Object(c.a)({},r)}else console.error("[App.js] Fetched spots data malformed:",e)}).catch(e=>{console.error("[App.js] Failed to fetch spots (network or parsing error):",e)})},[y]));Object(r.useEffect)(()=>{if(!e){const e=setTimeout(()=>{_()},1e3),t=setInterval(_,5e3);return()=>{clearTimeout(e),clearInterval(t)}}},[e,_]),Object(r.useEffect)(()=>{if(0===v.length)return;const e=v.map(e=>setTimeout(()=>x(t=>t.filter(t=>t.id!==e.id)),1e4));return()=>e.forEach(e=>clearTimeout(e))},[v]);const M=Object(r.useCallback)(e=>{const a={spots:e.map(e=>({id:String(e.id),x:Math.round(e.x),y:Math.round(e.y),w:Math.round(e.w),h:Math.round(e.h)}))};fetch(f,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then(e=>e.ok?e.json():e.json().then(t=>{const a=t.detail||"HTTP error ".concat(e.status);throw new Error(Array.isArray(a)?JSON.stringify(a):String(a))}).catch(()=>{throw new Error("HTTP error ".concat(e.status," from ").concat(f,". Non-JSON response."))})).then(e=>{if(e.message&&e.message.includes("Spots saved to DB successfully!"))t(!1),_();else{const t=e.detail?JSON.stringify(e.detail):e.message||"Save failed: Unknown structure.";console.error("Failed to save spots:",t,e),alert("Failed to save spots: ".concat(t))}}).catch(e=>{console.error("Error saving spots:",e),alert("Error saving spots: ".concat(e.message))})},[_]),I=Object(r.useCallback)(e=>{e&&T(Date.now())},[]),A=N?v.filter(e=>String(e.spot_id)===String(N)):v,F=a.length,U=Object.values(s).filter(e=>!e).length;return n.a.createElement("div",{className:"App min-h-screen bg-gray-100 text-gray-900"},n.a.createElement(l,{freeSpots:U,totalSpots:F}),n.a.createElement("div",{className:"container mx-auto px-4 py-8"},n.a.createElement("div",{className:"flex justify-center mb-6 space-x-4"},n.a.createElement("button",{onClick:()=>t(e=>!e),className:"px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition duration-150 ease-in-out"},e?"Cancel Spot Editing":"Edit Parking Spots"),!e&&n.a.createElement("button",{onClick:()=>{"webcam"!==j&&k("webcam"),T(Date.now())},className:"px-4 py-3 rounded-lg font-semibold shadow-md transition duration-150 ease-in-out bg-teal-600 text-white hover:bg-teal-700 focus:ring-teal-500 focus:outline-none focus:ring-2 focus:ring-opacity-75"},"Activate/Refresh Webcam Feed")),"webcam"===j&&n.a.createElement("div",{className:e?"hidden":"block mb-6"},n.a.createElement(b,{apiBaseUrl:p,onStreamingActive:I})),e?n.a.createElement(m,{initialSpots:a,videoSize:{width:800,height:600},onSave:M,setSpots:o,apiBaseUrl:p}):n.a.createElement(n.a.Fragment,null,n.a.createElement(i,{notes:A,onFilter:O,muted:y,toggleMute:()=>E(e=>!e)}),n.a.createElement("main",{className:"p-4"},"webcam"===j&&n.a.createElement("div",{className:"flex flex-col items-center mb-8"},n.a.createElement("h3",{className:"text-lg font-semibold mb-2 text-center text-gray-700"},"Processed Webcam Feed"),n.a.createElement("img",{key:C,src:h,alt:"Parking feed (processed by backend)",className:"w-full max-w-2xl rounded-lg shadow-lg border-2 border-gray-300",onError:e=>{e.target.alt="Feed unavailable.",e.target.src="https://placehold.co/640x480/2d3748/cbd5e0?text=Feed+Unavailable"}})),n.a.createElement("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"},a.map(e=>n.a.createElement(d,{key:e.id,id:e.id,isFree:!s[e.id],freeSince:g[e.id],highlight:String(N)===String(e.id)})))))))}var v=e=>{e&&e instanceof Function&&a.e(3).then(a.bind(null,35)).then(t=>{let{getCLS:a,getFID:r,getFCP:n,getLCP:o,getTTFB:s}=t;a(e),r(e),n(e),o(e),s(e)})};s.a.createRoot(document.getElementById("root")).render(n.a.createElement(n.a.StrictMode,null,n.a.createElement(w,null))),v()},8:function(e,t,a){}},[[16,1,2]]]);
//# sourceMappingURL=main.662cef25.chunk.js.map